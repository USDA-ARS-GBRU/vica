import vica
import tempfile
import os
import filecmp
import shutil
from nose.tools import ok_ , eq_

kmer_list = ['AAAA', 'AAAC', 'AAAG', 'AAAT', 'AACA', 'AACC', 'AACG', 'AACT', 'AAGA', 'AAGC', 'AAGG', 'AAGT', 'AATA', 'AATC', 'AATG', 'AATT', 'ACAA', 'ACAC', 'ACAG', 'ACAT', 'ACCA', 'ACCC', 'ACCG', 'ACCT', 'ACGA', 'ACGC', 'ACGG', 'ACGT', 'ACTA', 'ACTC', 'ACTG', 'AGAA', 'AGAC', 'AGAG', 'AGAT', 'AGCA', 'AGCC', 'AGCG', 'AGCT', 'AGGA', 'AGGC', 'AGGG', 'AGTA', 'AGTC', 'AGTG', 'ATAA', 'ATAC', 'ATAG', 'ATAT', 'ATCA', 'ATCC', 'ATCG', 'ATGA', 'ATGC', 'ATGG', 'ATTA', 'ATTC', 'ATTG', 'CAAA', 'CAAC', 'CAAG', 'CACA', 'CACC', 'CACG', 'CAGA', 'CAGC', 'CAGG', 'CATA', 'CATC', 'CATG', 'CCAA', 'CCAC', 'CCAG', 'CCCA', 'CCCC', 'CCCG', 'CCGA', 'CCGC', 'CCGG', 'CCTA', 'CCTC', 'CGAA', 'CGAC', 'CGAG', 'CGCA', 'CGCC', 'CGCG', 'CGGA', 'CGGC', 'CGTA', 'CGTC', 'CTAA', 'CTAC', 'CTAG', 'CTCA', 'CTCC', 'CTGA', 'CTGC', 'CTTA', 'CTTC', 'GAAA', 'GAAC', 'GACA', 'GACC', 'GAGA', 'GAGC', 'GATA', 'GATC', 'GCAA', 'GCAC', 'GCCA', 'GCCC', 'GCGA', 'GCGC', 'GCTA', 'GGAA', 'GGAC', 'GGCA', 'GGCC', 'GGGA', 'GGTA', 'GTAA', 'GTAC', 'GTCA', 'GTGA', 'GTTA', 'TAAA', 'TACA', 'TAGA', 'TATA', 'TCAA', 'TCCA', 'TCGA', 'TGAA', 'TGCA', 'TTAA']

def almost_equal(value_1, value_2, accuracy = 10**-8):
    '''a Function to compare tuples of float values'''
    return abs(value_1 - value_2) < accuracy

def test_iterate_kmer():
    expected = kmer_list
    results = vica.khmer_features.iterate_kmer(4)
    eq_(results, expected, msg="The function iterate_kmer did not return the \
        expected codon table for k=4")

def test_get_composition():
    seq='GTGAAACATTCGGATTTCGATATTGTCGTGATCGGGGCCGGACATGCCGGCGCCGAGGCTGCACATGCTGCGGCACGCATGGGAATGCGTACTGCCTTGGTTTCCCTGTCCGAACGCGACATTGGCGTGATGTCCTGTAA'
    expected1 = [0.0, 2.0, 0.0, 1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 1.0, 1.0, 3.0, 0.0, 1.0, 0.0, 2.0, 5.0, 1.0, 0.0, 0.0, 0.0, 1.0, 4.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 2.0, 1.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 2.0, 1.0, 2.0, 0.0, 4.0, 1.0, 0.0, 2.0, 2.0, 0.0, 0.0, 1.0, 1.0, 0.0, 3.0, 0.0, 2.0, 2.0, 0.0, 1.0, 3.0, 2.0, 0.0, 0.0, 1.0, 1.0, 1.0, 4.0, 1.0, 2.0, 0.0, 1.0, 3.0, 2.0, 1.0, 3.0, 3.0, 1.0, 3.0, 5.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 3.0, 0.0, 0.0, 3.0, 1.0, 5.0, 0.0, 0.0, 0.0, 1.0, 1.0, 0.0, 2.0, 1.0, 1.0, 1.0, 1.0, 0.0, 2.0, 3.0, 3.0, 1.0, 2.0, 0.0, 1.0, 1.0, 0.0, 3.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 1.0, 1.0, 1.0, 0.0]

    r1 = vica.khmer_features.get_composition(ksize=4, seq=seq, kmers=kmer_list)
    eq_(r1,expected1, msg="The un-normalized composition did not match it's expected result")

    expected2 = [0, 0.014598540145985401, 0.0072992700729927005, 0, 0.0072992700729927005, 0.0072992700729927005, 0, 0.0072992700729927005, 0.0072992700729927005, 0.0072992700729927005, 0, 0.021897810218978103, 0, 0, 0, 0.0072992700729927005, 0.0072992700729927005, 0, 0.0364963503649635, 0.014598540145985401, 0.0072992700729927005, 0, 0, 0, 0, 0, 0.0072992700729927005, 0.0072992700729927005, 0.029197080291970802, 0, 0, 0, 0, 0.0072992700729927005, 0, 0.014598540145985401, 0.0072992700729927005, 0, 0.014598540145985401, 0, 0.014598540145985401, 0.014598540145985401, 0, 0.029197080291970802, 0.0072992700729927005, 0, 0, 0, 0.0072992700729927005, 0.0072992700729927005, 0, 0, 0.0072992700729927005, 0, 0, 0.0072992700729927005, 0.014598540145985401, 0.0072992700729927005, 0, 0, 0.0072992700729927005, 0.0072992700729927005, 0, 0.021897810218978103, 0, 0.0072992700729927005, 0.021897810218978103, 0, 0.014598540145985401, 0.014598540145985401, 0.014598540145985401, 0, 0, 0.0072992700729927005, 0.0072992700729927005, 0.0072992700729927005, 0, 0.0072992700729927005, 0.029197080291970802, 0.0072992700729927005, 0.014598540145985401, 0, 0, 0, 0, 0, 0.0072992700729927005, 0, 0, 0, 0.021897810218978103, 0.021897810218978103, 0.014598540145985401, 0.021897810218978103, 0.021897810218978103, 0.0072992700729927005, 0.0072992700729927005, 0, 0.021897810218978103, 0.0364963503649635, 0, 0, 0.0072992700729927005, 0, 0, 0.0072992700729927005, 0, 0, 0, 0.021897810218978103, 0, 0.014598540145985401, 0, 0.0072992700729927005, 0.0072992700729927005, 0, 0.0072992700729927005, 0.0072992700729927005, 0.014598540145985401, 0.021897810218978103, 0, 0, 0.0072992700729927005, 0.021897810218978103, 0.0364963503649635, 0.0072992700729927005, 0.0072992700729927005, 0, 0.0072992700729927005, 0, 0.014598540145985401, 0.0072992700729927005, 0.0072992700729927005, 0.0072992700729927005, 0.021897810218978103, 0.0072992700729927005]


def test_write_kmers_as_csv():
    infile = 'tests/test-data/2testseqs.fasta'
    expected = 'tests/test-data/4mers.csv'
    dtemp = tempfile.mkdtemp()
    print(dtemp)
    outfile = os.path.join(dtemp,"outfile.csv")
    vica.khmer_features._write_kmers_as_csv(infile=infile, outfile=outfile, ksize=4, kmers=kmer_list)
    # ok_(filecmp.cmp(outfile, expected))
    shutil.rmtree(dtemp)
